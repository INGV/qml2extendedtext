[![TeamDigitale-publiccode](https://img.shields.io/badge/publiccode%20compliant-%E2%9C%94-blue.svg?logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAMAAAAolt3jAAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAAFxUExURQBmzABmzABmzABkywBkywBmzABmzABmzApszj2L2CyA1QBmzABmzABmzABlzABkywBlzABmzABkywBkywBkyyZ91OXv+qTH7AJlzABlzABmzABlzBJx0Hiu5EyU2wBmzECM2Wil4RRy0CZ91Orz+8/i9W2n4h950gBlzABkyzuJ2Pb6/bbT8AVpzZbA6vX5/TOE1iR80+jx+vn8/uXv+kKO2QBjywBlzA9vz3Cp4kmS2wBlzJbA6vX5/TOE1uvz+7LR8Ch+1AttzgBmzABmzABkywBkywBlzJbA6uz0+6PH7AFlzABmzABmzABlzJbA6jOE1iR70+z0+6TH7AFky5bA6jOF1hx30uPu+c/i9V+f3xl10QBlzABmzABlzIi459/s+TCD1gVpzZ7F7Pb6/evz+0CM2QBjywBmzBd00SV80whrzgBlzBFwzzqJ2DaG1wttzgBmzABmzABlzABlzABmzABmzABkywBkywBmzP///7f5b6EAAAABYktHRHo41YVqAAAAB3RJTUUH4wUWBTMYAFp7MgAAAF50RVh0UmF3IHByb2ZpbGUgdHlwZSBpcHRjAAppcHRjCiAgICAgIDI4CjM4NDI0OTRkMDQwNDAwMDAwMDAwMDAwZjFjMDI2ZTAwMDM1MjQ2NDcxYzAyMDAwMDAyMDAwNDAwCmCaPZ4AAAClSURBVAjXY2DAChiZmFlYwSw2EMHOwcnFzcPAwMvHLyAoJCwiKiYuISnFIC0jKyevoKikrKKqpq7BoKmlraOrp29gaGRsYmrGYG5haWVtY2tnaO/g6OTMwOvi6ubuAeR6enn7+IJMZfXztw0IDAoOkZaCcEP1w8IjIqOiY0Dc2Lj4hMSk5JTUtHSwOzIys7JzcvPyCwrB7ioqLiktMy+vqPRFczoAaG4fQ5lQVPsAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTktMDUtMjJUMDU6NTE6MjQtMDQ6MDDV7wZaAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE5LTA1LTIyVDA1OjUxOjI0LTA0OjAwpLK+5gAAAABJRU5ErkJggg==)](https://github.com/italia/publiccode.yml)
[![TeamDigitale-reuse](https://img.shields.io/badge/reuse%20software-%E2%9C%94-blue.svg?logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAMAAAAolt3jAAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAAFxUExURQBmzABmzABmzABkywBkywBmzABmzABmzApszj2L2CyA1QBmzABmzABmzABlzABkywBlzABmzABkywBkywBkyyZ91OXv+qTH7AJlzABlzABmzABlzBJx0Hiu5EyU2wBmzECM2Wil4RRy0CZ91Orz+8/i9W2n4h950gBlzABkyzuJ2Pb6/bbT8AVpzZbA6vX5/TOE1iR80+jx+vn8/uXv+kKO2QBjywBlzA9vz3Cp4kmS2wBlzJbA6vX5/TOE1uvz+7LR8Ch+1AttzgBmzABmzABkywBkywBlzJbA6uz0+6PH7AFlzABmzABmzABlzJbA6jOE1iR70+z0+6TH7AFky5bA6jOF1hx30uPu+c/i9V+f3xl10QBlzABmzABlzIi459/s+TCD1gVpzZ7F7Pb6/evz+0CM2QBjywBmzBd00SV80whrzgBlzBFwzzqJ2DaG1wttzgBmzABmzABlzABlzABmzABmzABkywBkywBmzP///7f5b6EAAAABYktHRHo41YVqAAAAB3RJTUUH4wUWBTMYAFp7MgAAAF50RVh0UmF3IHByb2ZpbGUgdHlwZSBpcHRjAAppcHRjCiAgICAgIDI4CjM4NDI0OTRkMDQwNDAwMDAwMDAwMDAwZjFjMDI2ZTAwMDM1MjQ2NDcxYzAyMDAwMDAyMDAwNDAwCmCaPZ4AAAClSURBVAjXY2DAChiZmFlYwSw2EMHOwcnFzcPAwMvHLyAoJCwiKiYuISnFIC0jKyevoKikrKKqpq7BoKmlraOrp29gaGRsYmrGYG5haWVtY2tnaO/g6OTMwOvi6ubuAeR6enn7+IJMZfXztw0IDAoOkZaCcEP1w8IjIqOiY0Dc2Lj4hMSk5JTUtHSwOzIys7JzcvPyCwrB7ioqLiktMy+vqPRFczoAaG4fQ5lQVPsAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTktMDUtMjJUMDU6NTE6MjQtMDQ6MDDV7wZaAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE5LTA1LTIyVDA1OjUxOjI0LTA0OjAwpLK+5gAAAABJRU5ErkJggg==)](https://developers.italia.it/it/software/ingv-ingv-qml2extendedtext)

[![License](https://img.shields.io/github/license/INGV/qml2extendedtext.svg)](https://github.com/INGV/qml2extendedtext/blob/main/LICENSE)
[![GitHub issues](https://img.shields.io/github/issues/INGV/qml2extendedtext.svg)](https://github.com/INGV/qml2extendedtext/issues)

[![Docker build](https://img.shields.io/badge/docker%20build-from%20CI-yellow)](https://hub.docker.com/r/ingv/qml2extendedtext)
![Docker Image Size (latest semver)](https://img.shields.io/docker/image-size/ingv/qml2extendedtext?sort=semver)
![Docker Pulls](https://img.shields.io/docker/pulls/ingv/qml2extendedtext)

# qml2extendedtext [![Version](https://img.shields.io/badge/dynamic/yaml?label=ver&query=softwareVersion&url=https://raw.githubusercontent.com/INGV/qml2extendedtext/main/publiccode.yml)](https://github.com/INGV/qml2extendedtext/blob/main/publiccode.yml) [![CircleCI](https://circleci.com/gh/INGV/qml2extendedtext/tree/main.svg?style=svg)](https://circleci.com/gh/INGV/qml2extendedtext/tree/main)

The qml2extendedtext.py code is included into the present docker.

The docker is used to parse a full QuakeML (xml) file or QuakeML webservice response containing information on hypocenter and related arrival times picks, and write the following information about the hypocenter on one single line:

- event_id: agency event unique identifier
- event_type: type of event (eg: earthquake, quarry blast and other agency dependent definitions)
- origin_id: agency hypocenter unique identifier; this correspond to the asked version of hypocenter that can be "preferred" or specific a-priori known location versions (see the tag below)
- version: this is a specific tag describing the type of solution (eg for INGV: 0,1,2 are automatic solutions (1 is not always present), 100,200,1000 are revised solutions and 1000 is the Bulletin one)
- ot: specific solution origintime in standard format YYYY-mm-ddTHH:MM:SS.x
- lon: hypocenter geographic longitude expressed in decimal degrees positive east from Greenwich
- lat: hypocenter geographic latitude expressed in decimal degrees positive northward
- depth: hypocenter depth expressed in km positive downward from the sea level
- err_ot: uncertainty on ot expressed in seconds
- err_lon: uncertainty on lon expressed in +/- km
- err_lat: uncertainty on lat expressed in +/- km
- err_depth: uncertainty on depth expressed in km
- err_h: horizontal error expressed in +/-km (not necessarily available)
- err_z: vertical error (like err_depth)
- nph_tot: total number of P+S arrivals (picks associated to the specific hypocenter)
- nph_tot_used: total number of P+S arrivals contributing to the specific hypocenter
- nph_p_used: number of P arrivals contributing to the specific hypocenter
- nph_s_used: number of S arrivals contributing to the specific hypocenter
- magnitud_id: agency unique identifier of the "hypocenter magnitude" (see below for the definition) magnitude associated to the specific hypocenter (this might be different from the preferred and from magnitudes associated to other hypocenters of the same event)
- magnitude_type: type of "hypocenter magnitude"
- magnitude_value: value of the "hypocenter magnitude"
- magnitude_err: uncertainty of the "hypocenter magnitude"
- magnitude_nsta_used: number of stations contributing to the "hypocenter magnitude"
- pref_magnitud_id: agency unique identifier of the "event magnitude" which is the preferred type and value of magnitude for the event, not necessarily associated to the specific hypocenter (eg: if a Mw is available it is preferred to the hypocenter related ML)
- pref_magnitude_type: type of the preferred magnitude
- pref_magnitude_value: value of the preferred magnitude
- pref_magnitude_err: uncertainty associated to the preferred magnitude (not always present)
- pref_magnitude_nsta_used: number of stations contributing to the preferred magnitude (non always present)
- rms: Root Mean Square of the location resituals of the specific hypocenter expressed in seconds
- gap: azimuthal gap of the contributing stations distribution
- source: the source of the QuakeML information (it is either a file name or a webservice query depnding on the used option, see below)

**Note**: the "hypocenter magnitude" is the magnitude directly associated to the specific hypocenter; it is calculated consequently to the hypocenter, it is tipically an ML and it might be not selected as the "preferred" if a hierarchically more reliable one is present (eg: Mw)

## Quickstart
### Docker image
To obtain *qml2extendedtext* docker image, you have two options:

#### 1) Get built image from DockerHub (*preferred*)
Get the last built image from DockerHub repository:
```
$ docker pull ingv/qml2extendedtext
```

#### 2) Build by yourself
First, clone the git repository
```
$ git clone https://github.com/INGV/qml2extendedtext.git
$ cd qml2extendedtext
$ docker build --tag ingv/qml2extendedtext .
```

in case of errors, try:
```
$ docker build --no-cache --pull --tag ingv/qml2extendedtext .
```

### Usage
```
usage: qml2extendedtext.py [-h] [--qmlin QMLIN] [--qmldir QMLDIR] [--eventid EVENTID] [--version VERSION] [--conf CONF] [--nophases] [--noamps] [--nofocals] [--agency AGENCY]

optional arguments:
  -h, --help         show this help message and exit
  --qmlin QMLIN      Full path to a single qml event file
  --qmldir QMLDIR    Full path to the directory containing more qml event files
  --eventid EVENTID  INGV event id
  --version VERSION  Agency coding origin version type (**default**: preferred) preferred,all, or an integer for known version numbers
  --conf CONF        needed with --eventid agency webservices routes list type (**default**: ./ws_agency_route.conf)
  --nophases         If on, no phase extraction and count is done
  --noamps           If on, no amp extraction and count is done
  --nofocals         If on, no focal mechanism extraction and count is done
  --agency AGENCY    needed with --eventid agency to query for (see routes list in .conf file) type (default: ingv)
```
**Note**: this script can be used either to parse QuakeML file(s) (--qmlin and --qmldir are alternative choices) or to get info from a webservice for a single event based on its unique identifier by the agency (--eventid)

An header is given in output in all cases at line one of the screen output. In the case of --qmldir this is a the top of a list of hypocenters.

### Run docker
To run the container, use the command below; the `-v` option is used to "mount" working directory into container:
```
$ docker run --rm --user $(id -u):$(id -g) -v $(pwd)/example:/opt/input ingv/qml2extendedtext
```

#### example with webservice (INGV)
```
$ docker run --rm --user $(id -u):$(id -g) -v $(pwd)/example:/opt/input ingv/qml2extendedtext python3 qml2extendedtext.py --eventid 25883521 --agency ingv --conf ./ws_agency_route.conf --version preferred
```

output:
```
event_id|event_type|origin_id|version|ot|lon|lat|depth|err_ot|err_lon|err_lat|err_depth|err_h|err_z|nph_tot|nph_tot_used|nph_p_used|nph_s_used|magnitud_id|magnitude_type|magnitude_value|magnitude_err|magnitude_nsta_used|pref_magnitud_id|pref_magnitude_type|pref_magnitude_value|pref_magnitude_err|pref_magnitude_nsta_used|rms|gap|source

25883521|earthquake|85930721|100|2021-01-01T01:09:10.220000Z|13.1877|42.8343|8.4|0.26|0.7991095982233789|0.8006034718408229|1.5|0.93|1.5|10|10|6|4|91710461|ML|1.3|0.2|4|91710461|ML|1.3|0.2|4|0.17|212.0|http://webservices.ingv.it/fdsnws/event/1/query?eventid=25883521&includeallmagnitudes=true&includeallorigins=true&includeallstationsmagnitudes=true&includearrivals=true
```

#### example with qml input file (same event)
```
$ docker run --rm --user $(id -u):$(id -g) -v $(pwd)/example:/opt/input ingv/qml2extendedtext python3 qml2extendedtext.py --qmlin example/20210101-010910__25883521__INGV-EVENT.qml --version preferred
```

output:
```
event_id|event_type|origin_id|version|ot|lon|lat|depth|err_ot|err_lon|err_lat|err_depth|err_h|err_z|nph_tot|nph_tot_used|nph_p_used|nph_s_used|magnitud_id|magnitude_type|magnitude_value|magnitude_err|magnitude_nsta_used|pref_magnitud_id|pref_magnitude_type|pref_magnitude_value|pref_magnitude_err|pref_magnitude_nsta_used|rms|gap|source

25883521|earthquake|85930721|100|2021-01-01T01:09:10.220000Z|13.1877|42.8343|8.4|0.26|0.7991095982233789|0.8006034718408229|1.5|0.93|1.5|10|10|6|4|91710461|ML|1.3|0.2|4|91710461|ML|1.3|0.2|4|0.17|212.0|20210101-010910__25883521__INGV-EVENT.qml
```

### Docker CLI
To override the `ENTRYPOINT` directive and enter into the Docker container, run:
```
$ docker run --rm -it --user $(id -u):$(id -g) --entrypoint=bash qml2extendedtext
```

## Example
![2021-qml2extendedtext](https://user-images.githubusercontent.com/16477095/115374480-2d946680-a1cd-11eb-90f3-6a894615eece.gif)

## Contribute
Thanks to your contributions!

Here is a list of users who already contributed to this repository:
<a href="https://github.com/ingv/qml2extendedtext/graphs/contributors">
  <img src="https://contrib.rocks/image?repo=ingv/qml2extendedtext" />
</a>

## Author
(c) 2021 Raffaele Distefano raffaele.distefano[at]ingv.it

(c) 2021 Valentino Lauciani valentino.lauciani[at]ingv.it

Istituto Nazionale di Geofisica e Vulcanologia, Italia

